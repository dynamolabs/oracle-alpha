<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Token Backtest | ORACLE Alpha</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #0a0a1a 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(0, 217, 255, 0.2);
    }
    
    .logo {
      font-size: 48px;
    }
    
    h1 {
      background: linear-gradient(90deg, #00d9ff, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 28px;
    }
    
    .back-link {
      margin-left: auto;
      color: #00d9ff;
      text-decoration: none;
      padding: 8px 16px;
      border: 1px solid #00d9ff;
      border-radius: 4px;
      transition: all 0.3s;
    }
    
    .back-link:hover {
      background: rgba(0, 217, 255, 0.1);
    }
    
    /* Input Section */
    .input-section {
      background: rgba(26, 26, 58, 0.8);
      border: 1px solid rgba(0, 217, 255, 0.2);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .input-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    
    .input-group {
      flex: 1;
      min-width: 200px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #888;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .input-group input, .input-group select {
      width: 100%;
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 217, 255, 0.3);
      border-radius: 8px;
      color: #fff;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #00d9ff;
      box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
    }
    
    .input-group input::placeholder {
      color: #666;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #00d9ff, #a855f7);
      color: #000;
      border: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 217, 255, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Results Section */
    .results-section {
      display: none;
    }
    
    .results-section.active {
      display: block;
    }
    
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .result-card {
      background: rgba(26, 26, 58, 0.8);
      border: 1px solid rgba(0, 217, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
    }
    
    .result-card h3 {
      color: #00d9ff;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .result-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .result-value.positive {
      color: #22c55e;
    }
    
    .result-value.negative {
      color: #ef4444;
    }
    
    .result-subtitle {
      color: #888;
      font-size: 12px;
    }
    
    .result-detail {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .result-detail:last-child {
      border-bottom: none;
    }
    
    .result-detail .label {
      color: #888;
    }
    
    .result-detail .value {
      font-weight: bold;
    }
    
    /* Strategy Section */
    .strategy-section {
      background: rgba(26, 26, 58, 0.8);
      border: 1px solid rgba(0, 217, 255, 0.2);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .strategy-section h3 {
      color: #a855f7;
      font-size: 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .strategy-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    
    .strategy-item {
      background: rgba(0, 0, 0, 0.2);
      padding: 16px;
      border-radius: 8px;
      border-left: 3px solid #a855f7;
    }
    
    .strategy-item .name {
      color: #888;
      font-size: 12px;
      margin-bottom: 8px;
    }
    
    .strategy-item .result {
      font-size: 20px;
      font-weight: bold;
    }
    
    .strategy-item .status {
      font-size: 11px;
      margin-top: 4px;
    }
    
    .status-hit {
      color: #22c55e;
    }
    
    .status-miss {
      color: #888;
    }
    
    /* Chart Section */
    .chart-section {
      background: rgba(26, 26, 58, 0.8);
      border: 1px solid rgba(0, 217, 255, 0.2);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .chart-section h3 {
      color: #00d9ff;
      font-size: 16px;
      margin-bottom: 20px;
    }
    
    #price-chart {
      width: 100%;
      height: 300px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }
    
    /* Loading State */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: #888;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 217, 255, 0.2);
      border-top-color: #00d9ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Error State */
    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    /* Token Header */
    .token-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding: 20px;
      background: rgba(26, 26, 58, 0.8);
      border: 1px solid rgba(0, 217, 255, 0.2);
      border-radius: 12px;
    }
    
    .token-symbol {
      font-size: 36px;
      font-weight: bold;
      color: #00d9ff;
    }
    
    .token-name {
      color: #888;
    }
    
    .token-meta {
      margin-left: auto;
      text-align: right;
    }
    
    .data-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      text-transform: uppercase;
      margin-top: 8px;
    }
    
    .data-badge.birdeye {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }
    
    .data-badge.dexscreener {
      background: rgba(0, 217, 255, 0.2);
      color: #00d9ff;
    }
    
    .data-badge.simulated {
      background: rgba(234, 179, 8, 0.2);
      color: #eab308;
    }
    
    /* Compare Section */
    .compare-section {
      margin-top: 40px;
      padding-top: 40px;
      border-top: 1px solid rgba(0, 217, 255, 0.2);
    }
    
    .compare-section h2 {
      color: #a855f7;
      margin-bottom: 20px;
    }
    
    .compare-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .compare-table th,
    .compare-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .compare-table th {
      color: #888;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .compare-table tr:hover td {
      background: rgba(0, 217, 255, 0.05);
    }
    
    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-size: 12px;
      font-weight: bold;
    }
    
    .rank-1 {
      background: linear-gradient(135deg, #ffd700, #ffaa00);
      color: #000;
    }
    
    .rank-2 {
      background: linear-gradient(135deg, #c0c0c0, #a0a0a0);
      color: #000;
    }
    
    .rank-3 {
      background: linear-gradient(135deg, #cd7f32, #a56d29);
      color: #000;
    }
    
    /* Footer */
    footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid rgba(0, 217, 255, 0.2);
      text-align: center;
      color: #666;
      font-size: 12px;
    }
    
    footer a {
      color: #00d9ff;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">üîç</div>
      <div>
        <h1>Token Backtest</h1>
        <p style="color: #888; font-size: 12px;">Analyze historical performance ‚Ä¢ Simulate entries ‚Ä¢ Test strategies</p>
      </div>
      <a href="/" class="back-link">‚Üê Dashboard</a>
    </header>
    
    <!-- Input Section -->
    <div class="input-section">
      <div class="input-row">
        <div class="input-group" style="flex: 2;">
          <label>Token Contract Address</label>
          <input type="text" id="token-input" placeholder="Enter Solana token CA (e.g., 7GCihgDB8fe6KNjn2MYtkzZcRjQy3t9GHdC8uHYmW2hr)">
        </div>
        <div class="input-group">
          <label>Entry Date (Optional)</label>
          <input type="date" id="entry-date">
        </div>
        <div class="input-group">
          <label>Entry Price (Optional)</label>
          <input type="number" id="entry-price" placeholder="0.00001" step="any">
        </div>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label>Timeframe</label>
          <select id="interval-select">
            <option value="1h" selected>1 Hour</option>
            <option value="4h">4 Hours</option>
            <option value="1d">1 Day</option>
          </select>
        </div>
        <div class="input-group">
          <label>History Period</label>
          <select id="days-select">
            <option value="7">7 Days</option>
            <option value="14">14 Days</option>
            <option value="30" selected>30 Days</option>
            <option value="60">60 Days</option>
            <option value="90">90 Days</option>
          </select>
        </div>
        <div class="input-group" style="display: flex; align-items: flex-end;">
          <button class="btn-primary" id="analyze-btn" onclick="runBacktest()">
            üîç Analyze Token
          </button>
        </div>
      </div>
    </div>
    
    <!-- Error Message -->
    <div class="error-message" id="error-message" style="display: none;"></div>
    
    <!-- Loading State -->
    <div class="loading" id="loading" style="display: none;">
      <div class="spinner"></div>
      <div>Fetching historical data...</div>
    </div>
    
    <!-- Results Section -->
    <div class="results-section" id="results-section">
      <!-- Token Header -->
      <div class="token-header" id="token-header">
        <div>
          <div class="token-symbol" id="result-symbol">$TOKEN</div>
          <div class="token-name" id="result-name">Token Name</div>
        </div>
        <div class="token-meta">
          <div id="result-mcap">MCap: -</div>
          <div id="result-age">Age: -</div>
          <span class="data-badge" id="data-source">BIRDEYE</span>
        </div>
      </div>
      
      <!-- Results Grid -->
      <div class="results-grid">
        <div class="result-card">
          <h3>üìä Current ROI</h3>
          <div class="result-value" id="roi-value">+0%</div>
          <div class="result-subtitle" id="roi-subtitle">Entry ‚Üí Current</div>
        </div>
        
        <div class="result-card">
          <h3>üèÜ ATH ROI</h3>
          <div class="result-value positive" id="ath-roi">+0%</div>
          <div class="result-subtitle" id="ath-date">at $0.00001 on -</div>
        </div>
        
        <div class="result-card">
          <h3>üìâ Max Drawdown</h3>
          <div class="result-value negative" id="max-drawdown">-0%</div>
          <div class="result-subtitle" id="drawdown-subtitle">Worst dip from peak</div>
        </div>
        
        <div class="result-card">
          <h3>üíé Optimal Exit</h3>
          <div class="result-value positive" id="optimal-exit">+0%</div>
          <div class="result-subtitle" id="optimal-date">on -</div>
        </div>
      </div>
      
      <!-- Entry/Current Details -->
      <div class="result-card" style="margin-bottom: 24px;">
        <h3>üìã Entry & Current Details</h3>
        <div class="result-detail">
          <span class="label">Entry Price</span>
          <span class="value" id="entry-price-value">$0.00000000</span>
        </div>
        <div class="result-detail">
          <span class="label">Entry Date</span>
          <span class="value" id="entry-date-value">-</span>
        </div>
        <div class="result-detail">
          <span class="label">Current Price</span>
          <span class="value" id="current-price-value">$0.00000000</span>
        </div>
        <div class="result-detail">
          <span class="label">ATH Price</span>
          <span class="value" id="ath-price-value">$0.00000000</span>
        </div>
        <div class="result-detail">
          <span class="label">Hold Duration</span>
          <span class="value" id="hold-duration">-</span>
        </div>
        <div class="result-detail">
          <span class="label">Volatility Score</span>
          <span class="value" id="volatility-score">-/100</span>
        </div>
      </div>
      
      <!-- Strategy Results -->
      <div class="strategy-section">
        <h3>üìà Strategy Simulations</h3>
        <div class="strategy-grid" id="strategy-grid">
          <!-- Will be populated by JS -->
        </div>
      </div>
      
      <!-- Chart Section -->
      <div class="chart-section">
        <h3>üìä Price History</h3>
        <div id="price-chart">
          <canvas id="chart-canvas"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Compare Section -->
    <div class="compare-section">
      <h2>üìä Compare Multiple Tokens</h2>
      <div class="input-section">
        <div class="input-row">
          <div class="input-group" style="flex: 3;">
            <label>Token Addresses (comma-separated)</label>
            <input type="text" id="compare-tokens" placeholder="Enter up to 10 token CAs, separated by commas">
          </div>
          <div class="input-group" style="display: flex; align-items: flex-end;">
            <button class="btn-primary" onclick="compareTokens()">
              Compare
            </button>
          </div>
        </div>
      </div>
      <div id="compare-results" style="display: none;">
        <table class="compare-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Token</th>
              <th>ROI</th>
              <th>ATH ROI</th>
              <th>Max Drawdown</th>
              <th>Volatility</th>
            </tr>
          </thead>
          <tbody id="compare-tbody">
          </tbody>
        </table>
      </div>
    </div>
    
    <footer>
      <p>Powered by <a href="/">ORACLE Alpha</a> ‚Ä¢ Data from DexScreener & Birdeye</p>
      <p style="margin-top: 8px;">‚ö†Ô∏è Historical performance does not guarantee future results</p>
    </footer>
  </div>
  
  <script>
    const API_BASE = '';
    
    function formatPrice(price) {
      if (price === 0) return '$0';
      if (price < 0.00000001) return '$' + price.toExponential(2);
      if (price < 0.0001) return '$' + price.toFixed(10);
      if (price < 1) return '$' + price.toFixed(6);
      return '$' + price.toFixed(4);
    }
    
    function formatPercent(value) {
      const sign = value >= 0 ? '+' : '';
      return sign + value.toFixed(2) + '%';
    }
    
    async function runBacktest() {
      const token = document.getElementById('token-input').value.trim();
      const entryDate = document.getElementById('entry-date').value;
      const entryPrice = document.getElementById('entry-price').value;
      const interval = document.getElementById('interval-select').value;
      const days = document.getElementById('days-select').value;
      
      if (!token) {
        showError('Please enter a token contract address');
        return;
      }
      
      // Show loading
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('results-section').classList.remove('active');
      document.getElementById('error-message').style.display = 'none';
      document.getElementById('analyze-btn').disabled = true;
      
      try {
        let url = `${API_BASE}/api/backtest/${token}?interval=${interval}&days=${days}`;
        if (entryDate) url += `&entryDate=${entryDate}`;
        if (entryPrice) url += `&entryPrice=${entryPrice}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (!response.ok || !data.success) {
          throw new Error(data.message || data.error || 'Backtest failed');
        }
        
        displayResults(data.backtest);
        
      } catch (error) {
        showError(error.message);
      } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('analyze-btn').disabled = false;
      }
    }
    
    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.textContent = '‚ùå ' + message;
      errorEl.style.display = 'block';
    }
    
    function displayResults(result) {
      // Token header
      document.getElementById('result-symbol').textContent = '$' + result.symbol;
      document.getElementById('result-name').textContent = result.name;
      document.getElementById('result-mcap').textContent = result.metadata.marketCap 
        ? 'MCap: $' + (result.metadata.marketCap / 1000000).toFixed(2) + 'M'
        : '';
      document.getElementById('result-age').textContent = result.metadata.tokenAge 
        ? 'Age: ' + result.metadata.tokenAge
        : '';
      
      const sourceEl = document.getElementById('data-source');
      sourceEl.textContent = result.dataSource.toUpperCase();
      sourceEl.className = 'data-badge ' + result.dataSource;
      
      // ROI values
      const roiValue = document.getElementById('roi-value');
      roiValue.textContent = formatPercent(result.roi.total);
      roiValue.className = 'result-value ' + (result.roi.total >= 0 ? 'positive' : 'negative');
      document.getElementById('roi-subtitle').textContent = `${result.entry.dateString} ‚Üí ${result.current.dateString}`;
      
      document.getElementById('ath-roi').textContent = formatPercent(result.ath.fromEntry);
      document.getElementById('ath-date').textContent = `at ${formatPrice(result.ath.price)} on ${result.ath.dateString}`;
      
      document.getElementById('max-drawdown').textContent = '-' + result.drawdown.maxDrawdownPct.toFixed(2) + '%';
      
      document.getElementById('optimal-exit').textContent = formatPercent(result.optimalExit.roi);
      document.getElementById('optimal-date').textContent = 'on ' + result.optimalExit.dateString;
      
      // Details
      document.getElementById('entry-price-value').textContent = formatPrice(result.entry.price);
      document.getElementById('entry-date-value').textContent = result.entry.dateString;
      document.getElementById('current-price-value').textContent = formatPrice(result.current.price);
      document.getElementById('ath-price-value').textContent = formatPrice(result.ath.price);
      document.getElementById('hold-duration').textContent = result.strategies.hold.holdDurationHuman;
      document.getElementById('volatility-score').textContent = result.volatility.volatilityScore.toFixed(0) + '/100';
      
      // Strategy grid
      const strategyGrid = document.getElementById('strategy-grid');
      strategyGrid.innerHTML = '';
      
      // Hold strategy
      strategyGrid.innerHTML += createStrategyItem('HOLD', result.strategies.hold.roiPercent, 'Current strategy');
      
      // Take profit strategies
      for (const [level, res] of Object.entries(result.strategies.takeProfitAt)) {
        if (res) {
          strategyGrid.innerHTML += createStrategyItem(`TP ${level}`, res.roiPercent, '‚úÖ Would have hit', true);
        } else {
          strategyGrid.innerHTML += createStrategyItem(`TP ${level}`, '-', '‚ùå Not reached', false);
        }
      }
      
      // Stop loss strategies
      for (const [level, res] of Object.entries(result.strategies.stopLossAt)) {
        if (res) {
          strategyGrid.innerHTML += createStrategyItem(`SL ${level}`, res.roiPercent, '‚ö†Ô∏è Would have triggered', true);
        } else {
          strategyGrid.innerHTML += createStrategyItem(`SL ${level}`, '-', '‚úÖ Not triggered', false);
        }
      }
      
      // Show results
      document.getElementById('results-section').classList.add('active');
      
      // Scroll to results
      document.getElementById('token-header').scrollIntoView({ behavior: 'smooth' });
    }
    
    function createStrategyItem(name, result, status, isActive) {
      const resultClass = result.includes('+') ? 'positive' : result.includes('-') ? 'negative' : '';
      const statusClass = isActive ? 'status-hit' : 'status-miss';
      
      return `
        <div class="strategy-item">
          <div class="name">${name}</div>
          <div class="result ${resultClass}">${result}</div>
          <div class="status ${statusClass}">${status}</div>
        </div>
      `;
    }
    
    async function compareTokens() {
      const tokensInput = document.getElementById('compare-tokens').value.trim();
      
      if (!tokensInput) {
        showError('Please enter token addresses to compare');
        return;
      }
      
      const interval = document.getElementById('interval-select').value;
      const days = document.getElementById('days-select').value;
      
      try {
        const url = `${API_BASE}/api/backtest/compare?tokens=${encodeURIComponent(tokensInput)}&interval=${interval}&days=${days}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (!response.ok || !data.success) {
          throw new Error(data.message || data.error || 'Comparison failed');
        }
        
        displayComparison(data.comparison);
        
      } catch (error) {
        showError(error.message);
      }
    }
    
    function displayComparison(result) {
      const tbody = document.getElementById('compare-tbody');
      tbody.innerHTML = '';
      
      for (const token of result.tokens) {
        const rankClass = token.rank <= 3 ? `rank-${token.rank}` : '';
        const roiClass = token.roi >= 0 ? 'positive' : 'negative';
        
        tbody.innerHTML += `
          <tr>
            <td><span class="rank-badge ${rankClass}">${token.rank}</span></td>
            <td style="color: #00d9ff; font-weight: bold;">$${token.symbol}</td>
            <td class="${roiClass}">${formatPercent(token.roi)}</td>
            <td class="positive">${formatPercent(token.athRoi)}</td>
            <td class="negative">-${token.maxDrawdown.toFixed(1)}%</td>
            <td>${token.volatility.toFixed(0)}/100</td>
          </tr>
        `;
      }
      
      document.getElementById('compare-results').style.display = 'block';
    }
    
    // Enter key support
    document.getElementById('token-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') runBacktest();
    });
  </script>
</body>
</html>
